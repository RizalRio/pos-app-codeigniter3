let isCetak=!1,produk=[],transaksi=$("#transaksi").DataTable({responsive:!0,lengthChange:!1,searching:!1,scrollX:!0});function reloadTable(){transaksi.ajax.reload()}function getNama(){$.ajax({url:produkGetNamaUrl,type:"post",dataType:"json",data:{id:$(".produk-container-item.active").data("id")},success(a){$("#nama_produk").html(a.nama_produk),$("#sisa").html(`Sisa ${a.stok}`),checkEmpty()},error(a){console.log(a)}})}function getProdukByKategori(){var a="";$.ajax({url:produkGetByCategory,type:"post",dataType:"json",data:{id:$("#barcode").val()},success(b){$("#produk-container").empty(),b&&(b.forEach(function(b,c){a+=`<div class="container bg-secondary py-3 px-2 mb-4 produk-container-item" style="border-radius: 12px;" data-id="${b.id}">
												<div class="row">
													<div class="col-lg-4">
														<div class="d-flex justify-content-center">
															<div class="my-auto">
																<img src="${getUrl+"uploads/produk/"+b.gambar}" style="width: 15vh;height: 15vh;">
															</div>
														</div>
													</div>
													<div class="col-lg-8 d-flex">
														<div class="my-auto">
															<h5>${b.nama_produk}</h5>
															<p>Harga : ${b.harga}</p>
															<small class="form-text">Sisa ${b.stok}</small>
														</div>
													</div>
												</div>
											</div>
					
					`}),$("#produk-container").append(a)),checkEmpty()},error(a){console.log(a)}})}function checkStok(){$.ajax({url:produkGetStokUrl,type:"post",dataType:"json",data:{id:$(".produk-container-item.active").data("id")},success(c){let e=$(".produk-container-item.active").data("id"),j=c.nama_produk,a=parseInt($("#jumlah").val()),d=parseInt(c.stok),f=parseInt(c.harga),k=c.barcode,g=parseInt($("#total").html());if(d<a)Swal.fire("Gagal","Stok Tidak Cukup","warning");else{let h=transaksi.rows().indexes().filter((a,b)=>k===transaksi.row(a).data()[0]);if(h.length>0){let i=transaksi.row(h[0]),b=i.data();d<b[3]+a?Swal.fire("stok","Stok Tidak Cukup","warning"):(b[3]=b[3]+a,i.data(b).draw(),indexProduk=produk.findIndex(a=>a.id==e),produk[indexProduk].stok=d-b[3],$("#total").html(g+f*a))}else produk.push({id:e,stok:d-a,terjual:a}),transaksi.row.add([k,j,f,a,`<button name="${e}" class="btn btn-sm btn-danger" onclick="remove('${e}')">Hapus</btn>`]).draw(),$("#total").html(g+f*a),$("#jumlah").val(""),$("#tambah").attr("disabled","disabled"),$("#bayar").removeAttr("disabled")}}})}function bayarCetak(){isCetak=!0}function bayar(){isCetak=!1}function checkEmpty(){let b=$("#barcode").val(),a=$("#jumlah").val();""!==b&&""!==a&&parseInt(a)>=1?$("#tambah").removeAttr("disabled"):$("#tambah").attr("disabled","disabled")}function checkUang(){let a=$('[name="jumlah_uang"').val(),b=parseInt($(".total_bayar").html());""!==a&&a>=b?($("#add").removeAttr("disabled"),$("#cetak").removeAttr("disabled")):($("#add").attr("disabled","disabled"),$("#cetak").attr("disabled","disabled"))}function remove(a){let b=transaksi.row($("[name="+a+"]").closest("tr")).data(),c=b[3],d=b[2],e=parseInt($("#total").html());akhir=e-c*d,$("#total").html(akhir),transaksi.row($("[name="+a+"]").closest("tr")).remove().draw(),$("#tambah").attr("disabled","disabled"),akhir<1&&$("#bayar").attr("disabled","disabled")}function add(){let a=transaksi.rows().data(),b=[];$.each(a,(c,a)=>{b.push(a[3])}),$.ajax({url:addUrl,type:"post",dataType:"json",data:{produk:JSON.stringify(produk),tanggal:$("#tanggal").val(),qty:b,total_bayar:$("#total").html(),jumlah_uang:$('[name="jumlah_uang"]').val(),diskon:$('[name="diskon"]').val(),pelanggan:$("#pelanggan").val(),nota:$("#nota").html()},success(a){isCetak?Swal.fire("Sukses","Sukses Membayar","success").then(()=>window.location.href=`${cetakUrl}${a}`):Swal.fire("Sukses","Sukses Membayar","success").then(()=>window.location.reload())},error(a){console.log(a)}})}function kembalian(){let a=$("#total").html(),b=$('[name="jumlah_uang"').val(),c=$('[name="diskon"]').val();$(".kembalian").html(b-a-c),checkUang()}$("#barcode").select2({placeholder:"Kategori",ajax:{url:getCategoryUrl,type:"post",dataType:"json",data:a=>({kategori:a.term}),processResults:a=>({results:a}),cache:!0}}),$("#pelanggan").select2({placeholder:"Pelanggan",ajax:{url:pelangganSearchUrl,type:"post",dataType:"json",data:a=>({pelanggan:a.term}),processResults:a=>({results:a}),cache:!0}}),$("#tanggal").datetimepicker({format:"dd-mm-yyyy h:ii:ss"}),$(".modal").on("hidden.bs.modal",()=>{$("#form")[0].reset(),$("#form").validate().resetForm()}),$(".modal").on("show.bs.modal",()=>{let b=moment().format("D-MM-Y H:mm:ss"),a=$("#total").html(),c=$('[name="jumlah_uang"').val();$("#tanggal").val(b),$(".total_bayar").html(a),$(".kembalian").html(Math.max(c-a,0))}),$("#form").validate({errorElement:"span",errorPlacement(a,b){a.addClass("invalid-feedback"),b.closest(".form-group").append(a)},submitHandler(){add()}}),$(document).on("click",".produk-container-item",function(){$(".produk-container-item").removeClass("active"),$(this).addClass("active")})
